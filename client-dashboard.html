<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í´ë¼ì´ì–¸íŠ¸ ëŒ€ì‹œë³´ë“œ - UTOPIA X</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/chat.css">
    <style>
        /* Global Loading Overlay */
        #globalLoadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        #globalLoadingOverlay.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(157, 78, 221, 0.2);
            border-top-color: #9d4edd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 20px;
            color: white;
            font-size: 18px;
            font-weight: 500;
        }
        
        /* Hide dashboard content until loaded */
        body.loading .dashboard-container,
        body.loading nav {
            display: none !important;
        }
        
        .dashboard-container {
            max-width: 1200px;
            margin: 100px auto 60px;
            padding: 0 20px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .dashboard-title h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .dashboard-title p {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(157, 78, 221, 0.2);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }
        
        .stat-icon.credit {
            background: linear-gradient(135deg, #E91E84, #9D4EDD);
            color: white;
        }
        
        .stat-icon.dancers {
            background: linear-gradient(135deg, #6366F1, #3B82F6);
            color: white;
        }
        
        .stat-icon.projects {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .dashboard-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .dancer-list {
            display: grid;
            gap: 16px;
        }
        
        .dancer-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(157, 78, 221, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .dancer-item:hover {
            background: rgba(157, 78, 221, 0.1);
            border-color: var(--primary-purple);
        }
        
        .dancer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-purple);
        }
        
        .dancer-info {
            flex: 1;
        }
        
        .dancer-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .dancer-genre {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .dancer-contact {
            font-size: 14px;
            color: var(--primary-purple);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state p {
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .dancer-item {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase Initialization -->
    <script>
        const SUPABASE_URL = 'https://idfpmynjfkvtcsqcjgnm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlkZnBteW5qZmt2dGNzcWNqZ25tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NzQ2NTgsImV4cCI6MjA4NTI1MDY1OH0.KFmClnG-XuW818uUIMlPW0yQ7UswXvIWh-ipv6z5p4I';
        if (typeof supabase !== 'undefined') {
            window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("âœ… Supabase Connected!");
        }
    </script>
    
    <!-- Dashboard Loader (MUST load first) -->
    <script src="js/dashboard-loader.js"></script>
</head>
<body class="loading">
    <!-- Global Loading Overlay -->
    <div id="globalLoadingOverlay">
        <div class="loading-spinner"></div>
        <p class="loading-text">ëŒ€ì‹œë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="index.html" class="logo">
                    <img src="https://www.genspark.ai/api/files/s/qeJgU55W" alt="UTOPIA X">
                </a>
                <ul class="nav-links">
                    <li><a href="index.html">í™ˆ</a></li>
                    <li><a href="#" class="active">ëŒ€ì‹œë³´ë“œ</a></li>
                </ul>
                <div class="user-menu">
                    <button class="user-menu-btn" id="userMenuBtn">
                        <i class="fas fa-user-circle"></i>
                        <span class="user-email" id="userEmailDisplay">Loading...</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <div class="user-menu-header">
                            <div class="credit-display">
                                <i class="fas fa-coins"></i>
                                <span id="creditDisplay">0</span> C
                            </div>
                            <button class="btn btn-sm btn-gradient" id="btnCreditCharge">í¬ë ˆë”§ ì¶©ì „</button>
                        </div>
                        <div class="user-menu-items">
                            <button class="user-menu-item" id="btnMyProfile">
                                <i class="fas fa-user"></i>
                                ë‚´ ì •ë³´
                            </button>
                            <button class="user-menu-item" id="btnPurchaseHistory">
                                <i class="fas fa-receipt"></i>
                                êµ¬ë§¤ ë‚´ì—­
                            </button>
                            <button class="user-menu-item" id="btnUnlockedDancers">
                                <i class="fas fa-unlock"></i>
                                ì ê¸ˆ í•´ì œ ëŒ„ì„œ
                            </button>
                        </div>
                        <div class="user-menu-divider"></div>
                        <button class="user-menu-item logout-btn" id="btnLogout">
                            <i class="fas fa-sign-out-alt"></i>
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <h1>í´ë¼ì´ì–¸íŠ¸ ëŒ€ì‹œë³´ë“œ</h1>
                <p id="welcomeMessage">í™˜ì˜í•©ë‹ˆë‹¤! ëŒ„ì„œ ì„­ì™¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
            </div>
            <button onclick="openChatListModal()" class="btn btn-gradient" style="position: relative;">
                <i class="fas fa-comments"></i>
                1:1 ì±„íŒ… (Messages)
                <span id="chatUnreadBadge" class="badge-notification" style="display: none;">0</span>
            </button>
        </div>

        <!-- Stats -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon credit">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-value" id="statCredits">10</div>
                <div class="stat-label">ì”ì—¬ í¬ë ˆë”§</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon dancers">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-value" id="statUnlockedDancers">0</div>
                <div class="stat-label">ì ê¸ˆ í•´ì œ ëŒ„ì„œ</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon projects">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div class="stat-value" id="statProjects">0</div>
                <div class="stat-label">ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸</div>
            </div>
        </div>

        <!-- Unlocked Dancers -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-unlock"></i>
                    ìµœê·¼ ë³¸ ëŒ„ì„œ
                </h2>
            </div>
            <div class="dancer-list" id="unlockedDancersList">
                <!-- Empty state -->
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <p>ì•„ì§ ì ê¸ˆ í•´ì œí•œ ëŒ„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p style="margin-top: 10px; font-size: 14px;">ëŒ„ì„œ í”„ë¡œí•„ì„ í™•ì¸í•˜ê³  ì—°ë½ì²˜ë¥¼ ì ê¸ˆ í•´ì œí•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Authentication System -->
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-auth.js"></script>
    
    <!-- Main Scripts -->
    <script src="js/credit-system.js"></script>
    
    <!-- Dashboard Script -->
    <script>
        // Check authentication
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“Š Loading client dashboard...');
            
            // Check if user is logged in
            const userEmail = sessionStorage.getItem('userEmail');
            const userRole = sessionStorage.getItem('userRole');
            
            if (!userEmail) {
                console.log('âš ï¸ No user logged in, redirecting to home');
                showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                return;
            }
            
            // Check if user is client
            if (userRole !== 'client') {
                console.log('âš ï¸ User is not a client, redirecting...');
                showToast('í´ë¼ì´ì–¸íŠ¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
                setTimeout(() => {
                    if (userRole === 'artist') {
                        window.location.href = 'artist-dashboard.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }, 1000);
                return;
            }
            
            // Update UI with user data
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const welcomeMessage = document.getElementById('welcomeMessage');
            
            if (userEmailDisplay) {
                userEmailDisplay.textContent = userEmail;
            }
            
            if (welcomeMessage) {
                welcomeMessage.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${userEmail}!`;
            }
            
            // Load user data
            loadDashboardData();
            
            // Initialize event listeners
            initDashboardEvents();
            
            console.log('âœ… Dashboard loaded');
        });
        
        // Load dashboard data
        function loadDashboardData() {
            // Mock data for now
            const mockCredits = 10;
            const mockUnlockedDancers = 0;
            const mockProjects = 0;
            
            // Update stats
            document.getElementById('statCredits').textContent = mockCredits;
            document.getElementById('statUnlockedDancers').textContent = mockUnlockedDancers;
            document.getElementById('statProjects').textContent = mockProjects;
            document.getElementById('creditDisplay').textContent = mockCredits;
            
            // Load unlocked dancers
            loadUnlockedDancers();
        }
        
        // Load unlocked dancers
        function loadUnlockedDancers() {
            const unlockedDancersList = document.getElementById('unlockedDancersList');
            
            // Check localStorage for unlocked dancers
            const unlockedDancers = JSON.parse(localStorage.getItem('unlockedDancers') || '[]');
            
            if (unlockedDancers.length === 0) {
                // Show empty state (already in HTML)
                return;
            }
            
            // Clear empty state
            unlockedDancersList.innerHTML = '';
            
            // Render unlocked dancers
            unlockedDancers.forEach(dancer => {
                const dancerItem = document.createElement('div');
                dancerItem.className = 'dancer-item';
                dancerItem.innerHTML = `
                    <img src="${dancer.image || 'https://via.placeholder.com/60'}" 
                         alt="${dancer.name}" 
                         class="dancer-avatar">
                    <div class="dancer-info">
                        <div class="dancer-name">${dancer.name}</div>
                        <div class="dancer-genre">${dancer.genre || 'Hip-hop'}</div>
                    </div>
                    <div class="dancer-contact">
                        <i class="fas fa-phone"></i>
                        ${dancer.contact || '010-XXXX-XXXX'}
                    </div>
                `;
                unlockedDancersList.appendChild(dancerItem);
            });
            
            // Update stat
            document.getElementById('statUnlockedDancers').textContent = unlockedDancers.length;
        }
        
        // Initialize dashboard events
        function initDashboardEvents() {
            // Logout button
            const logoutBtn = document.getElementById('btnLogout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    console.log('ğŸ‘‹ Logging out...');
                    
                    // Sign out
                    if (typeof signOut === 'function') {
                        await signOut();
                    } else {
                        // Fallback
                        sessionStorage.clear();
                        localStorage.removeItem('unlockedDancers');
                        showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        window.location.href = 'index.html';
                    }
                });
            }
            
            // User menu toggle
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userMenuDropdown = document.getElementById('userMenuDropdown');
            
            if (userMenuBtn && userMenuDropdown) {
                userMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userMenuDropdown.classList.toggle('active');
                });
                
                // Close on outside click
                document.addEventListener('click', () => {
                    userMenuDropdown.classList.remove('active');
                });
            }
            
            // Credit charge button
            const btnCreditCharge = document.getElementById('btnCreditCharge');
            if (btnCreditCharge) {
                btnCreditCharge.addEventListener('click', () => {
                    showToast('í¬ë ˆë”§ ì¶©ì „ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤', 'info');
                });
            }
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
    </script>
    
    <!-- Chat Module -->
    <script src="js/chat.js"></script>
    
    <!-- Chat Modal -->
    <div id="chatListModal" class="modal" style="display: none;">
        <div class="modal-content modal-md">
            <button class="modal-close" onclick="closeChatListModal()">&times;</button>
            <div class="modal-header">
                <h2><i class="fas fa-comments"></i> ì±„íŒ… ëª©ë¡</h2>
                <p>ëŒ„ì„œë“¤ê³¼ì˜ ëŒ€í™” ë‚´ì—­</p>
            </div>
            <div id="chatListContainer" class="chat-list-container">
                <p class="text-center text-muted">ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>
    </div>
    
    <!-- Chat Window Modal -->
    <div id="chatModal" class="modal" style="display: none;">
        <div class="modal-content modal-md chat-modal">
            <div class="chat-header">
                <button class="modal-close" onclick="ChatModule.closeChatModal()">&times;</button>
                <div class="chat-partner-info">
                    <i class="fas fa-user-circle" style="font-size: 24px; margin-right: 10px;"></i>
                    <div>
                        <h3 id="chatPartnerName">ìƒëŒ€ë°©</h3>
                        <span class="chat-status" id="chatStatus">
                            <i class="fas fa-circle"></i> ì˜¨ë¼ì¸
                        </span>
                    </div>
                </div>
            </div>
            
            <div id="chatMessages" class="chat-messages">
                <!-- Messages will be rendered here -->
            </div>
            
            <div class="chat-input-container">
                <input 
                    type="text" 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    onkeypress="if(event.key === 'Enter') sendChatMessage()"
                >
                <button class="btn-send" onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Chat Functions -->
    <script>
        // Open chat list modal
        async function openChatListModal() {
            console.log('ğŸ’¬ Opening chat list...');
            
            const modal = document.getElementById('chatListModal');
            if (modal) {
                modal.style.display = 'flex';
            }
            
            // Load conversations
            await loadChatList();
        }
        
        // Close chat list modal
        function closeChatListModal() {
            const modal = document.getElementById('chatListModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Load chat list
        async function loadChatList() {
            const container = document.getElementById('chatListContainer');
            if (!container) return;
            
            container.innerHTML = '<p class="text-center text-muted">ì±„íŒ… ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            
            // Initialize ChatModule if not already
            if (!ChatModule.currentUserId) {
                const success = await ChatModule.init();
                if (!success) {
                    container.innerHTML = '<p class="text-center text-danger">ì±„íŒ… ì‹œìŠ¤í…œì„ ì´ˆê¸°í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
            }
            
            // Load conversations
            await ChatModule.loadConversations();
            
            if (ChatModule.state.conversations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-comments" style="font-size: 64px; color: var(--text-muted); margin-bottom: 20px;"></i>
                        <p class="text-muted">ì•„ì§ ì±„íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-muted" style="font-size: 14px;">ëŒ„ì„œ í”„ë¡œí•„ì—ì„œ '1:1 ë¬¸ì˜í•˜ê¸°'ë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }
            
            // Render conversations
            container.innerHTML = ChatModule.state.conversations.map(conv => `
                <div class="chat-list-item" onclick="openChatWithPartner('${conv.partnerId}')">
                    <div class="chat-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-name">Partner ID: ${conv.partnerId.substring(0, 8)}...</div>
                        <div class="chat-preview">${conv.lastMessage}</div>
                    </div>
                    <div class="chat-meta">
                        <div class="chat-time">${ChatModule.formatTime(conv.lastMessageTime)}</div>
                        ${conv.unreadCount > 0 ? `<span class="badge-notification">${conv.unreadCount}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Open chat with specific partner
        async function openChatWithPartner(partnerId) {
            console.log('ğŸ’¬ Opening chat with:', partnerId);
            
            // Close chat list modal
            closeChatListModal();
            
            // Open chat window
            await ChatModule.openChatWith(partnerId, 'Partner', null);
        }
        
        // Send chat message
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            if (!input) return;
            
            const message = input.value.trim();
            if (!message) return;
            
            console.log('ğŸ“¤ Sending message:', message);
            
            // Send via ChatModule
            const result = await ChatModule.sendMessage(
                ChatModule.state.currentChatPartnerId,
                message
            );
            
            if (result.success) {
                // Clear input
                input.value = '';
                
                // Render new message
                ChatModule.renderNewMessage(result.data);
            } else {
                showToast('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨', 'error');
            }
        }
    </script>
</body>
</html>
