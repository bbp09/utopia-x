<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í´ë¼ì´ì–¸íŠ¸ ëŒ€ì‹œë³´ë“œ - UTOPIA X</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;900&family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 100px auto 60px;
            padding: 0 20px;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .dashboard-title h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .dashboard-title p {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(157, 78, 221, 0.2);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }
        
        .stat-icon.credit {
            background: linear-gradient(135deg, #E91E84, #9D4EDD);
            color: white;
        }
        
        .stat-icon.dancers {
            background: linear-gradient(135deg, #6366F1, #3B82F6);
            color: white;
        }
        
        .stat-icon.projects {
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .dashboard-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .dancer-list {
            display: grid;
            gap: 16px;
        }
        
        .dancer-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(157, 78, 221, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        
        .dancer-item:hover {
            background: rgba(157, 78, 221, 0.1);
            border-color: var(--primary-purple);
        }
        
        .dancer-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-purple);
        }
        
        .dancer-info {
            flex: 1;
        }
        
        .dancer-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .dancer-genre {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .dancer-contact {
            font-size: 14px;
            color: var(--primary-purple);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .empty-state p {
            font-size: 16px;
        }
        
        /* Chat Styles */
        .conversation-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .conversation-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(157, 78, 221, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .conversation-item:hover {
            background: rgba(157, 78, 221, 0.1);
            border-color: var(--primary-purple);
            transform: translateX(5px);
        }
        
        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E91E84, #9D4EDD);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
        }
        
        .conversation-info {
            flex: 1;
        }
        
        .conversation-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .conversation-last-message {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .conversation-meta {
            text-align: right;
        }
        
        .conversation-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .unread-badge {
            display: inline-block;
            background: #E91E84;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .message-item {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }
        
        .message-item.sent {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #E91E84, #9D4EDD);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .message-content {
            max-width: 60%;
        }
        
        .message-bubble {
            background: rgba(157, 78, 221, 0.1);
            border: 1px solid var(--border-color);
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 4px;
            word-wrap: break-word;
        }
        
        .message-item.sent .message-bubble {
            background: linear-gradient(135deg, #E91E84, #9D4EDD);
            color: white;
            border: none;
        }
        
        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            padding: 0 4px;
        }
        
        .btn-icon {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-icon:hover {
            background: rgba(157, 78, 221, 0.1);
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .dancer-item {
                flex-direction: column;
                text-align: center;
            }
            
            .message-content {
                max-width: 80%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="index.html" class="logo">
                    <img src="https://www.genspark.ai/api/files/s/qeJgU55W" alt="UTOPIA X">
                </a>
                <ul class="nav-links">
                    <li><a href="index.html">í™ˆ</a></li>
                    <li><a href="#" class="active">ëŒ€ì‹œë³´ë“œ</a></li>
                </ul>
                <div class="user-menu">
                    <button class="user-menu-btn" id="userMenuBtn">
                        <i class="fas fa-user-circle"></i>
                        <span class="user-email" id="userEmailDisplay">Loading...</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <div class="user-menu-header">
                            <div class="credit-display">
                                <i class="fas fa-coins"></i>
                                <span id="creditDisplay">0</span> C
                            </div>
                            <button class="btn btn-sm btn-gradient" id="btnCreditCharge">í¬ë ˆë”§ ì¶©ì „</button>
                        </div>
                        <div class="user-menu-items">
                            <button class="user-menu-item" id="btnMyProfile">
                                <i class="fas fa-user"></i>
                                ë‚´ ì •ë³´
                            </button>
                            <button class="user-menu-item" id="btnPurchaseHistory">
                                <i class="fas fa-receipt"></i>
                                êµ¬ë§¤ ë‚´ì—­
                            </button>
                            <button class="user-menu-item" id="btnUnlockedDancers">
                                <i class="fas fa-unlock"></i>
                                ì ê¸ˆ í•´ì œ ëŒ„ì„œ
                            </button>
                        </div>
                        <div class="user-menu-divider"></div>
                        <button class="user-menu-item logout-btn" id="btnLogout">
                            <i class="fas fa-sign-out-alt"></i>
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="dashboard-title">
                <h1>í´ë¼ì´ì–¸íŠ¸ ëŒ€ì‹œë³´ë“œ</h1>
                <p id="welcomeMessage">í™˜ì˜í•©ë‹ˆë‹¤! ëŒ„ì„œ ì„­ì™¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
            </div>
            <button id="btnOpenChatList" class="btn btn-gradient">
                <i class="fas fa-comments"></i>
                1:1 ì±„íŒ… (Messages)
            </button>
        </div>

        <!-- Stats -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-icon credit">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-value" id="statCredits">10</div>
                <div class="stat-label">ì”ì—¬ í¬ë ˆë”§</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon dancers">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-value" id="statUnlockedDancers">0</div>
                <div class="stat-label">ì ê¸ˆ í•´ì œ ëŒ„ì„œ</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon projects">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div class="stat-value" id="statProjects">0</div>
                <div class="stat-label">ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸</div>
            </div>
        </div>

        <!-- Unlocked Dancers -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-unlock"></i>
                    ìµœê·¼ ë³¸ ëŒ„ì„œ
                </h2>
            </div>
            <div class="dancer-list" id="unlockedDancersList">
                <!-- Empty state -->
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <p>ì•„ì§ ì ê¸ˆ í•´ì œí•œ ëŒ„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p style="margin-top: 10px; font-size: 14px;">ëŒ„ì„œ í”„ë¡œí•„ì„ í™•ì¸í•˜ê³  ì—°ë½ì²˜ë¥¼ ì ê¸ˆ í•´ì œí•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat List Modal -->
    <div id="chatListModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-comments"></i>
                    1:1 ì±„íŒ…
                </h2>
                <button class="modal-close" id="closeChatListModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="conversationList" class="conversation-list">
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>ì•„ì§ ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p style="margin-top: 10px; font-size: 14px;">ëŒ„ì„œ í”„ë¡œí•„ì—ì„œ [1:1 ë¬¸ì˜í•˜ê¸°]ë¥¼ í´ë¦­í•˜ì—¬ ì±„íŒ…ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Room Modal -->
    <div id="chatRoomModal" class="modal" style="display: none;">
        <div class="modal-content chat-room" style="max-width: 800px; height: 600px; display: flex; flex-direction: column;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button id="btnBackToChatList" class="btn-icon">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-partner-info">
                        <h3 id="chatPartnerName" style="margin: 0; font-size: 18px;">Loading...</h3>
                        <p id="chatPartnerRole" style="margin: 0; font-size: 12px; color: var(--text-secondary);">Artist</p>
                    </div>
                </div>
                <button class="modal-close" id="closeChatRoomModal">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
                <div id="chatMessages" class="chat-messages">
                    <!-- Messages will be dynamically loaded -->
                </div>
            </div>
            <div class="chat-input-area" style="padding: 15px; border-top: 1px solid var(--border-color);">
                <div style="display: flex; gap: 10px;">
                    <input 
                        type="text" 
                        id="chatMessageInput" 
                        class="form-input" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        style="flex: 1;"
                    >
                    <button id="btnSendMessage" class="btn btn-gradient">
                        <i class="fas fa-paper-plane"></i>
                        ì „ì†¡
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Authentication System -->
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-auth.js"></script>
    
    <!-- Main Scripts -->
    <script src="js/credit-system.js"></script>
    <script type="module" src="js/chat.js"></script>
    
    <!-- Dashboard Script -->
    <script>
        // Check authentication
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“Š Loading client dashboard...');
            
            // Check if user is logged in
            const userEmail = sessionStorage.getItem('userEmail');
            const userRole = sessionStorage.getItem('userRole');
            
            if (!userEmail) {
                console.log('âš ï¸ No user logged in, redirecting to home');
                showToast('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'info');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
                return;
            }
            
            // Check if user is client
            if (userRole !== 'client') {
                console.log('âš ï¸ User is not a client, redirecting...');
                showToast('í´ë¼ì´ì–¸íŠ¸ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
                setTimeout(() => {
                    if (userRole === 'artist') {
                        window.location.href = 'artist-dashboard.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }, 1000);
                return;
            }
            
            // Update UI with user data
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const welcomeMessage = document.getElementById('welcomeMessage');
            
            if (userEmailDisplay) {
                userEmailDisplay.textContent = userEmail;
            }
            
            if (welcomeMessage) {
                welcomeMessage.textContent = `í™˜ì˜í•©ë‹ˆë‹¤, ${userEmail}!`;
            }
            
            // Load user data
            loadDashboardData();
            
            // Initialize event listeners
            initDashboardEvents();
            
            console.log('âœ… Dashboard loaded');
        });
        
        // Load dashboard data
        function loadDashboardData() {
            // Mock data for now
            const mockCredits = 10;
            const mockUnlockedDancers = 0;
            const mockProjects = 0;
            
            // Update stats
            document.getElementById('statCredits').textContent = mockCredits;
            document.getElementById('statUnlockedDancers').textContent = mockUnlockedDancers;
            document.getElementById('statProjects').textContent = mockProjects;
            document.getElementById('creditDisplay').textContent = mockCredits;
            
            // Load unlocked dancers
            loadUnlockedDancers();
        }
        
        // Load unlocked dancers
        function loadUnlockedDancers() {
            const unlockedDancersList = document.getElementById('unlockedDancersList');
            
            // Check localStorage for unlocked dancers
            const unlockedDancers = JSON.parse(localStorage.getItem('unlockedDancers') || '[]');
            
            if (unlockedDancers.length === 0) {
                // Show empty state (already in HTML)
                return;
            }
            
            // Clear empty state
            unlockedDancersList.innerHTML = '';
            
            // Render unlocked dancers
            unlockedDancers.forEach(dancer => {
                const dancerItem = document.createElement('div');
                dancerItem.className = 'dancer-item';
                dancerItem.innerHTML = `
                    <img src="${dancer.image || 'https://via.placeholder.com/60'}" 
                         alt="${dancer.name}" 
                         class="dancer-avatar">
                    <div class="dancer-info">
                        <div class="dancer-name">${dancer.name}</div>
                        <div class="dancer-genre">${dancer.genre || 'Hip-hop'}</div>
                    </div>
                    <div class="dancer-contact">
                        <i class="fas fa-phone"></i>
                        ${dancer.contact || '010-XXXX-XXXX'}
                    </div>
                `;
                unlockedDancersList.appendChild(dancerItem);
            });
            
            // Update stat
            document.getElementById('statUnlockedDancers').textContent = unlockedDancers.length;
        }
        
        // Initialize dashboard events
        function initDashboardEvents() {
            // Logout button
            const logoutBtn = document.getElementById('btnLogout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    console.log('ğŸ‘‹ Logging out...');
                    
                    // Sign out
                    if (typeof signOut === 'function') {
                        await signOut();
                    } else {
                        // Fallback
                        sessionStorage.clear();
                        localStorage.removeItem('unlockedDancers');
                        showToast('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
                        window.location.href = 'index.html';
                    }
                });
            }
            
            // User menu toggle
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userMenuDropdown = document.getElementById('userMenuDropdown');
            
            if (userMenuBtn && userMenuDropdown) {
                userMenuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    userMenuDropdown.classList.toggle('active');
                });
                
                // Close on outside click
                document.addEventListener('click', () => {
                    userMenuDropdown.classList.remove('active');
                });
            }
            
            // Credit charge button
            const btnCreditCharge = document.getElementById('btnCreditCharge');
            if (btnCreditCharge) {
                btnCreditCharge.addEventListener('click', () => {
                    showToast('í¬ë ˆë”§ ì¶©ì „ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤', 'info');
                });
            }
            
            // Chat functionality
            setupChatListeners();
        }
        
        // Setup chat listeners
        async function setupChatListeners() {
            const btnOpenChatList = document.getElementById('btnOpenChatList');
            const chatListModal = document.getElementById('chatListModal');
            const chatRoomModal = document.getElementById('chatRoomModal');
            const closeChatListModal = document.getElementById('closeChatListModal');
            const closeChatRoomModal = document.getElementById('closeChatRoomModal');
            const btnBackToChatList = document.getElementById('btnBackToChatList');
            const btnSendMessage = document.getElementById('btnSendMessage');
            const chatMessageInput = document.getElementById('chatMessageInput');
            
            let chatModule = null;
            let currentPartnerId = null;
            
            // Import and initialize chat module
            try {
                const { initChat } = await import('./js/chat.js');
                chatModule = initChat();
                console.log('âœ… Chat module loaded');
            } catch (error) {
                console.error('âŒ Failed to load chat module:', error);
            }
            
            // Open chat list
            if (btnOpenChatList) {
                btnOpenChatList.addEventListener('click', async () => {
                    if (!chatModule) {
                        showToast('ì±„íŒ… ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'info');
                        return;
                    }
                    
                    chatListModal.style.display = 'flex';
                    await loadConversations();
                });
            }
            
            // Close modals
            if (closeChatListModal) {
                closeChatListModal.addEventListener('click', () => {
                    chatListModal.style.display = 'none';
                });
            }
            
            if (closeChatRoomModal) {
                closeChatRoomModal.addEventListener('click', () => {
                    chatRoomModal.style.display = 'none';
                    if (chatModule) {
                        chatModule.closeChat();
                    }
                });
            }
            
            // Back to chat list
            if (btnBackToChatList) {
                btnBackToChatList.addEventListener('click', () => {
                    chatRoomModal.style.display = 'none';
                    chatListModal.style.display = 'flex';
                    if (chatModule) {
                        chatModule.closeChat();
                    }
                });
            }
            
            // Send message
            if (btnSendMessage) {
                btnSendMessage.addEventListener('click', () => sendMessage());
            }
            
            if (chatMessageInput) {
                chatMessageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            // Load conversations
            async function loadConversations() {
                const conversationList = document.getElementById('conversationList');
                
                try {
                    const conversations = await chatModule.getConversations();
                    
                    if (conversations.length === 0) {
                        conversationList.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>ì•„ì§ ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p style="margin-top: 10px; font-size: 14px;">ëŒ„ì„œ í”„ë¡œí•„ì—ì„œ [1:1 ë¬¸ì˜í•˜ê¸°]ë¥¼ í´ë¦­í•˜ì—¬ ì±„íŒ…ì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    conversationList.innerHTML = conversations.map(conv => {
                        const partnerName = conv.partner.full_name || conv.partner.email;
                        const partnerInitial = partnerName.charAt(0).toUpperCase();
                        const lastMessageText = conv.lastMessage?.content || 'ë©”ì‹œì§€ ì—†ìŒ';
                        const lastMessageTime = conv.lastMessage ? formatTime(conv.lastMessage.created_at) : '';
                        
                        return `
                            <div class="conversation-item" data-partner-id="${conv.partner.id}">
                                <div class="conversation-avatar">${partnerInitial}</div>
                                <div class="conversation-info">
                                    <div class="conversation-name">${partnerName}</div>
                                    <div class="conversation-last-message">${lastMessageText}</div>
                                </div>
                                <div class="conversation-meta">
                                    <div class="conversation-time">${lastMessageTime}</div>
                                    ${conv.unreadCount > 0 ? `<span class="unread-badge">${conv.unreadCount}</span>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Add click listeners to conversations
                    conversationList.querySelectorAll('.conversation-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const partnerId = item.dataset.partnerId;
                            openChatRoom(partnerId);
                        });
                    });
                    
                } catch (error) {
                    console.error('âŒ Error loading conversations:', error);
                    showToast('ëŒ€í™” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
            
            // Open chat room
            async function openChatRoom(partnerId) {
                currentPartnerId = partnerId;
                chatListModal.style.display = 'none';
                chatRoomModal.style.display = 'flex';
                
                try {
                    const messages = await chatModule.openChat(partnerId);
                    const partner = chatModule.currentChatPartner;
                    
                    // Update header
                    document.getElementById('chatPartnerName').textContent = partner.full_name || partner.email;
                    document.getElementById('chatPartnerRole').textContent = partner.role === 'artist' ? 'ì•„í‹°ìŠ¤íŠ¸' : 'í´ë¼ì´ì–¸íŠ¸';
                    
                    // Render messages
                    renderMessages(messages);
                    
                    // Scroll to bottom
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                } catch (error) {
                    console.error('âŒ Error opening chat:', error);
                    showToast('ì±„íŒ…ë°©ì„ ì—¬ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
            
            // Render messages
            function renderMessages(messages) {
                const chatMessages = document.getElementById('chatMessages');
                const currentUserId = chatModule.currentUser.id;
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”!</p>
                        </div>
                    `;
                    return;
                }
                
                chatMessages.innerHTML = messages.map(msg => {
                    const isSent = msg.sender_id === currentUserId;
                    const senderName = isSent ? 'ë‚˜' : (chatModule.currentChatPartner?.full_name || 'User');
                    const senderInitial = senderName.charAt(0).toUpperCase();
                    
                    return `
                        <div class="message-item ${isSent ? 'sent' : 'received'}">
                            <div class="message-avatar">${senderInitial}</div>
                            <div class="message-content">
                                <div class="message-bubble">${escapeHtml(msg.content)}</div>
                                <div class="message-time">${formatTime(msg.created_at)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Send message
            async function sendMessage() {
                const content = chatMessageInput.value.trim();
                
                if (!content) return;
                if (!currentPartnerId) {
                    showToast('ì±„íŒ… ìƒëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”', 'error');
                    return;
                }
                
                try {
                    await chatModule.sendMessage(currentPartnerId, content);
                    chatMessageInput.value = '';
                    
                    // Reload messages
                    const messages = await chatModule.getChatHistory(currentPartnerId);
                    renderMessages(messages);
                    
                    // Scroll to bottom
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                } catch (error) {
                    console.error('âŒ Error sending message:', error);
                    showToast('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                }
            }
            
            // Helper functions
            function formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;
                
                // Less than 1 minute
                if (diff < 60000) {
                    return 'ë°©ê¸ˆ';
                }
                // Less than 1 hour
                if (diff < 3600000) {
                    return `${Math.floor(diff / 60000)}ë¶„ ì „`;
                }
                // Less than 24 hours
                if (diff < 86400000) {
                    return `${Math.floor(diff / 3600000)}ì‹œê°„ ì „`;
                }
                // Same year
                if (date.getFullYear() === now.getFullYear()) {
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                }
                // Different year
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Global functions for chat module callbacks
            window.updateChatUI = (partner, messages) => {
                renderMessages(messages);
            };
            
            window.appendChatMessage = (message) => {
                const chatMessages = document.getElementById('chatMessages');
                const currentUserId = chatModule.currentUser.id;
                const isSent = message.sender_id === currentUserId;
                const senderName = isSent ? 'ë‚˜' : (chatModule.currentChatPartner?.full_name || 'User');
                const senderInitial = senderName.charAt(0).toUpperCase();
                
                const messageHtml = `
                    <div class="message-item ${isSent ? 'sent' : 'received'}">
                        <div class="message-avatar">${senderInitial}</div>
                        <div class="message-content">
                            <div class="message-bubble">${escapeHtml(message.content)}</div>
                            <div class="message-time">${formatTime(message.created_at)}</div>
                        </div>
                    </div>
                `;
                
                chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };
            
            window.updateConversationList = () => {
                if (chatListModal.style.display === 'flex') {
                    loadConversations();
                }
            };
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            if (toast) {
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            } else {
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
    </script>
</body>
</html>
